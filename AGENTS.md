# AI Agent Instructions

This document describes the HELLDIVERS 2 StreamController plugin for AI coding assistants.

## Project Overview

This is a StreamController plugin that lets users trigger Helldivers 2 stratagems from a Stream Deck. Each stratagem has:
- A **key sequence** (arrow directions like UP, DOWN, LEFT, RIGHT)
- An **icon** (PNG with colored corner borders)
- **Locale strings** (display name and button labels)

## Architecture

### Source of Truth

**`update/config.py`** contains `STRATAGEM_MAPPINGS` - the single source of truth for all stratagems:

```python
STRATAGEM_MAPPINGS = {
    "InternalKey": {
        "wiki": "Name on wiki.gg",      # For scraping sequences
        "svg": "Name in SVG repo",       # For icon generation
        "name": "Display Name",          # For locale strings
    },
}
```

### Generated Files

These files are **generated** from `config.py` - do not edit manually:

| File | Generated By | Contains |
|------|--------------|----------|
| `assets/data/stratagems.json` | `stratagems.py` | Key sequences from wiki |
| `locales/en_US.json` | `locales.py` | Display names and labels |
| `assets/icons/*.png` | `icons.py` | Icons with corner borders |
| `../../pages/HD2 Test *.json` | `pages.py` | Test pages with all stratagems |

### Plugin Structure

```
main.py             # Plugin entry point
├── StratagemHeroButton    # Toggles "Hero mode" (no modifier key needed)
├── StratagemButton        # Executes stratagem sequences via UInput
├── CustomStratagemButton  # User-defined custom stratagem with configurable sequence
├── SequenceEditorRow      # GTK widget for editing custom sequences
└── HellDiversPlugin       # Plugin base with settings UI
```

### Update Module Structure

```
update/
├── config.py       # STRATAGEM_MAPPINGS, paths, color mappings
├── cli.py          # CLI entry point and commands
├── download.py     # Downloads SVGs from GitHub
├── icons.py        # Converts SVGs to PNGs with borders
├── locales.py      # Generates en_US.json
├── stratagems.py   # Generates stratagems.json
├── scraper.py      # Scrapes wiki.gg for sequences
├── pages.py        # Generates test pages for StreamController
└── __main__.py     # Enables `python -m update`
```

## Common Tasks

### Adding New Stratagems

1. Run `python -m update discover` to find new stratagems
2. Add suggested entries to `STRATAGEM_MAPPINGS` in `config.py`
3. Run `python -m update generate-all` to regenerate assets

### Fixing a Stratagem Sequence

Sequences come from wiki.gg. If incorrect:
1. Check the wiki page first - it may be the source
2. The sequence will auto-correct on next `generate-all`
3. Manual edits to `stratagems.json` will be overwritten

### Fixing an Icon

Icons come from the GitHub SVG repository. If an icon is wrong:
1. Check `config.py` - the `svg` field may point to wrong SVG
2. Run `python -m update icons` to regenerate

### Fixing Display Names/Labels

Labels are auto-generated from the `name` field in `config.py` by `locales.py`.

#### Label Generation Rules

Stream Deck buttons have 3 label positions: **top**, **center**, **bottom**.
The `split_into_labels()` function distributes words across these positions:

| Word Count | Top | Center | Bottom | Example |
|------------|-----|--------|--------|---------|
| 1 word | "" | "" | word | "Railgun" → bottom: "Railgun" |
| 2 words | "" | word1 | word2 | "Jump Pack" → center: "Jump", bottom: "Pack" |
| 3 words | word1 | word2 | word3 | "Eagle Smoke Strike" → top: "Eagle", center: "Smoke", bottom: "Strike" |
| 4+ words | word1 | middle | last | "Orbital 120MM HE Barrage" → top: "Orbital", center: "120MM HE", bottom: "Barrage" |

#### Maximum Label Length

Default max is **12 characters** per label. For 4+ word names, if the center label exceeds this:
1. Try: first word | second word | remaining words
2. If still too long, truncate to 12 characters

#### Quoted Names (Guard Dog variants)

Quoted phrases like `"Guard Dog"` are kept together:
- `"Guard Dog" Rover` → center: `"Guard Dog"`, bottom: `Rover`
- `"Guard Dog" Dog Breath` → top: `"Guard Dog"`, center: `Dog`, bottom: `Breath`

#### Customizing Labels

To change label generation logic, edit `update/locales.py`:
- `split_into_labels()` - The main splitting algorithm
- `max_label_length` parameter - Default 12 characters

#### Tips for Good Display Names

When adding the `name` field in `config.py`:
- Use 2-3 words for best results
- Avoid very long words (>12 chars) in middle positions
- Keep important identifiers in the bottom label (most visible)
- Model numbers work well in center position

## Plugin Settings

The plugin has a settings page accessible via **Settings → Plugins → HELLDIVERS 2 → Settings (gear icon)**.

### Available Settings

| Setting | Description | Default |
|---------|-------------|---------|
| **Key Delay** | Delay between key presses (0.01-0.20 seconds). Increase if stratagems fail. | 0.03s |
| **Modifier Key** | Key to open stratagem menu when not in Hero mode. Options: Left/Right Ctrl, Alt, Shift | Left Ctrl |
| **Hold Modifier Key** | If ON, holds modifier during entire sequence. If OFF, presses/releases modifier then types sequence. | ON |
| **Show Labels** | If ON, displays text labels on stratagem buttons. If OFF, shows icons only. | ON |

### Settings Implementation

Settings are managed through StreamController's plugin settings system:

1. `self.has_plugin_settings = True` enables the settings button
2. `get_settings_area()` returns an `Adw.PreferencesGroup` with the settings UI
3. `get_settings()` / `set_settings()` from `PluginBase` handle persistence
4. Settings are stored in `data/settings/plugins/net_jslay_helldivers_2/settings.json`

### Key Constants in `main.py`

```python
DEFAULT_KEY_DELAY = 0.03        # Seconds between key presses
DEFAULT_MODIFIER_KEY = "KEY_LEFTCTRL"  # evdev key code
DEFAULT_HOLD_MODIFIER = True    # Hold modifier during sequence
DEFAULT_SHOW_LABELS = True      # Show text labels on buttons

MODIFIER_KEYS = {
    "Left Ctrl": "KEY_LEFTCTRL",
    "Right Ctrl": "KEY_RIGHTCTRL",
    "Left Alt": "KEY_LEFTALT",
    "Right Alt": "KEY_RIGHTALT",
    "Left Shift": "KEY_LEFTSHIFT",
    "Right Shift": "KEY_RIGHTSHIFT",
}
```

### Adding New Settings

1. Add a default constant at the top of `main.py`
2. Add a getter method (e.g., `get_new_setting()`)
3. Add a UI creation method (e.g., `_create_new_setting_row()`)
4. Add a change handler (e.g., `_on_new_setting_changed()`)
5. Add the row to `get_settings_area()`
6. Use the getter where needed in the action code

## Key Implementation Details

### Color Mapping

SVG colors are mapped to more saturated colors in `config.py`:

```python
COLOR_MAPPINGS = {
    "#c9b269": "#f0c628",  # Gold
    "#de7b6c": "#d11a38",  # Red
    "#679552": "#60bf01",  # Green
}
```

### Corner Border Removal

Some SVGs have built-in corner borders that conflict with our custom borders.
`icons.py` detects and removes these before rendering.

### Wiki Scraping

The wiki uses full model numbers (e.g., "MG-43 Machine Gun").
The `wiki` field in `config.py` must match exactly.

### SVG Repository

Icons come from: https://github.com/nvigneux/Helldivers-2-Stratagems-icons-svg

SVG names often differ from wiki names (e.g., "Machine Gun" vs "MG-43 Machine Gun").

## Testing Stratagems

A standalone validator tool captures keyboard input and matches it to stratagems:

```bash
cd /path/to/net_jslay_helldivers_2
python test_stratagems.py
```

### How It Works

1. Focus the window
2. Press your Stream Deck button (or type arrow keys manually)
3. The tool displays the input sequence (↑ ↓ ← →)
4. Shows which stratagem matches the sequence
5. Press Escape to clear and try another

### What It Shows

- **Input Sequence**: Arrow keys displayed as ↑ ↓ ← →
- **Modifier Key**: Which modifier was used (Left Ctrl, Right Alt, etc.)
- **Modifier Mode**: Whether the modifier was:
  - ✓ HELD during entire sequence
  - ⚡ PRESSED then released before sequence
  - ⚠ Mixed (some keys with, some without modifier)
- **Matched Stratagem**: Exact match or partial matches

### Use Cases

- **Verify Stream Deck buttons**: Press a button and see if the correct stratagem is detected
- **Debug modifier behavior**: Check if Ctrl is being held or just pressed
- **Debug sequences**: Check if `stratagems.json` has the right key sequences
- **Test without game**: Validate everything works before launching Helldivers 2

## Test Pages

The update module can generate StreamController pages containing all stratagems for testing:

```bash
python -m update pages           # Generate test pages
python -m update pages --list    # List existing test pages
python -m update pages --clean   # Remove generated test pages
```

### Page Layout

- **Standard Stream Deck**: 5 columns × 3 rows = 15 keys
- **Navigation**: Bottom-left (previous) and bottom-right (next) for page switching
- **Hero Toggle**: On first page, bottom row
- **Circular navigation**: Last page connects to first page

### Generated Pages

Pages are named `HD2 Test 1.json`, `HD2 Test 2.json`, etc. and placed in the `data/pages/` directory.

Each page contains:
- 13 stratagems (15 keys minus 2 navigation buttons)
- Page switch actions for navigation
- Hero mode toggle on the first page

## Running the Update Module

First-time setup:

```bash
cd /path/to/net_jslay_helldivers_2
python -m venv .venv
source .venv/bin/activate
pip install -r update/requirements.txt
```

Running commands:

```bash
cd /path/to/net_jslay_helldivers_2
source .venv/bin/activate
python -m update [command]
```

## Dependencies

See `update/requirements.txt`:
- `beautifulsoup4` - HTML parsing for wiki scraping
- `cairosvg` - SVG to PNG conversion
- `pillow` - Image manipulation for borders
- `requests` - HTTP requests

The `.venv` directory is in `.gitignore`.

## Custom Stratagems

Users can create custom stratagem buttons for stratagems not yet in the plugin's mapping.

### How It Works

1. Add the **Custom Stratagem** action to a Stream Deck button
2. Click the button to open its configuration panel
3. Configure:
   - **Stratagem Name**: Internal name for the stratagem
   - **Top/Center/Bottom Labels**: Text displayed on the button
   - **Key Sequence**: Build the sequence using the direction buttons (↑ ↓ ← →)

### Custom Stratagem Settings

Each custom stratagem stores its settings per-button in the page JSON:

```json
{
  "name": "My Custom Stratagem",
  "labels": {
    "top": "",
    "center": "My Custom",
    "bottom": "Stratagem"
  },
  "sequence": ["UP", "DOWN", "LEFT", "RIGHT"]
}
```

### Implementation Details

- `CustomStratagemButton` extends `KeyAction` with `has_configuration = True`
- `get_config_rows()` returns the configuration UI rows
- `SequenceEditorRow` provides the visual sequence builder with direction buttons
- Settings are stored per-action using `self.get_settings()` / `self.set_settings()`
- Uses the same execution logic as `StratagemButton` (modifier key handling, key delay, etc.)

### Default Icon

Custom stratagems use `assets/icons/custom.png` - a gold "?" icon matching the plugin's style.
Users can eventually set custom icons via the icon_path setting (future enhancement).

## Backward Compatibility

The internal keys (e.g., `MachineGun`, `SOSBeacon`) are used as action IDs.
**Never rename existing keys** - this would break users' configured buttons.

When the game renames a stratagem:
- Keep the old key
- Update only the `wiki`, `svg`, and `name` fields
